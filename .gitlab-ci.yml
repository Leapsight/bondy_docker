image: docker:latest

stages:
  - build

# Hidden key that defines an anchor named 'build'
.job_template: &build
  services:
    - docker:dind
  before_script:
    - echo "CI_JOB_NAME = $CI_JOB_NAME"
    - BONDY_TAG="${BONDY_TAG:-BONDY_IMAGE_VERSION}"
    - echo "Logging in to registry $CI_REGISTRY"
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - echo "Building tag=$BONDY_TAG name=$CI_JOB_NAME version=$BONDY_IMAGE_VERSION, variant=$BONDY_IMAGE_VARIANT"
    # - image="leapsight/bondy:${BONDY_IMAGE_VERSION}${BONDY_IMAGE_VARIANT:+-$BONDY_IMAGE_VARIANT}"
    - image="leapsight/bondy:${CI_JOB_NAME}"
    # - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}"
    - rm -rf tmp
    - mkdir tmp
    - cp "${BONDY_IMAGE_VERSION}/${VARIANT:-.}/Dockerfile" tmp/Dockerfile
    - cp start.sh tmp/start.sh
  script:
    # Build using $VARIANT/Dockerfile orelse ./Dockerfile
    # - docker build --pull -t "$image" "${VARIANT:-.}"
    - docker build --build-arg BONDY_TAG=${BONDY_TAG} --pull -t "$image" tmp
    - docker push "$image"

  only:
    - master



# ==============================================================================
# DEVELOP
# ==============================================================================



develop:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "develop"
  <<: *build

develop-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "develop"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build



# ==============================================================================
# MASTER
# ==============================================================================



master:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "master"
  <<: *build

master-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "master"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build



# ==============================================================================
# 0.8
# ==============================================================================



0.8.5:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.5"
  <<: *build

0.8.5-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.5"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build

0.8.6:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.6"
  <<: *build

0.8.6-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.6"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build

0.8.7:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.7"
  <<: *build

0.8.7-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.7"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build

0.8.8:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.8.3"
  <<: *build

0.8.8-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.8.3"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build

0.8.8.3:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.8.3"
  <<: *build

0.8.8.3-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.8.3"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build

0.8.8.2:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.8.2"
  <<: *build

0.8.8.2-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.8.2"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build

'0.8':
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.8.3"
  <<: *build

0.8-slim:
  stage: build
  variables:
    BONDY_IMAGE_VERSION: "0.8"
    BONDY_TAG: "0.8.8.3"
    BONDY_IMAGE_VARIANT: "slim"
  <<: *build



# ==============================================================================
# 0.9
# ==============================================================================
